---
title: "Vignette for flipscores"
author: "All of us"
date: "`r Sys.Date()`"
output: 
  html_document: 
    toc: yes
---

# Introduction

both fit generalized linear models and perform many tests on coefficients.
All of them based on flipped likelihood scores. Referring to canonical glm function options,
it is expanded with testing ways on coefficients: test statistic type, score type,
resampling type and test direction. The resulting output is same as classical glms,
but p-value is calculated accounting to new preferencies.

## Sintax and parameters

The main input parameters of `flipscores()` are:   

- formula: an object of class "formula" (or one that can be coerced to that class): a symbolic description of the model to be fitted.
- data: an optional data frame, list or environment (or object coercible by as.data.frame to a data frame)
containing the variables in the model. If not found in data, the variables are taken from environment(formula),
typically the environment from which glm is called.
- family: a description of the error distribution and link function to be used in the model. Specifing Negative binomial family quotes has to be used.
- score_type: The type of score that is computed, either "orthogonalized", "effective" or "basic". 
By default is "orthogonalized". 
Both "orthogonalized effective score" and "effective score" take account of nuisance estimation and they provide the same test statistic. In case of small samples "effective score" might be anti-conservative. "orthogonalized effective score" gives a solution for this issue. 
Note that in case of a big model matrix, the "orthogonalized effective score" requires several time.
- n_flips: The number of random flips of the scores contributions.
When n_flips is equal or larger than the maximum number of possible flips (i.e. n^2), all possible flips are performed. 
Default is 5000.
- id: a vector identifying the clustered observations. If NULL (default) observations are assumed to be independent. 
- alternative: Should be "greater", "less" or "two.sided" (default).



```{r}
library(flipscores)
```

# Examples

## Logistic

```{r}

data(Titanic)
Titanic=dplyr::as_tibble(Titanic)

# Get the row indices to replicate
idx <- rep(1:nrow(Titanic),Titanic$n)
# Drop count column n
Titanic$n <- NULL
# replicate each row n-times
Titanic=Titanic[idx, ]
Titanic$Survived=as.factor(Titanic$Survived)

summary(glm(Survived~.+Class*Sex,data=Titanic,family = binomial))

mod=flipscores(Survived~Class*Sex+Age,data=Titanic,family = binomial, score_type = "effective")
summary(mod)
```

## Poisson 
 
```{r}

Titanic=as.data.frame(datasets::Titanic)

mod=flipscores(Freq~.+Class*Sex, data=Titanic, family = poisson)
summary(mod)
```

## Linear model 
 
```{r}

trees=as.data.frame(datasets::trees)

mod=flipscores(Volume~Girth*Height, data=trees, family = gaussian)
summary(mod)
```

## Gamma model 
 
```{r}

cars=datasets::cars

mod=flipscores(speed~dist, data=cars, family = Gamma, score_type = "ortho")
summary(mod)
```

## Negative Binomial 
 
```{r}
# Titanic=as.data.frame(datasets::Titanic)

# mod=flipscores(Freq~.+Class*Sex, data=Titanic, family = "negbinom")
# summary(mod)
```


# Other examples, simulated data

```{r}

set.seed(1)
x=(rep(0:1,20))
D=data.frame(y=rbinom(40,1,.25+x*.5),x=x,
             z=rnorm(40),id=rep(1:20,each=2))

mod_par=glm(y~x*z,data=D,family = binomial)
summary(mod_par)
mod_par

mod=flipscores(y~x*z,data=D,family = binomial,score_type = "ortho")
summary(mod)

print(mod)

## clustered units
mod=flipscores(y~x*z,data=D,family = binomial,id=D$id)
summary(mod)


##### poisson
D$y=rpois(40,exp(1+.25*x))
summary(glm(y~x*z,data=D,family = poisson))
mod=flipscores(y~x*z,data=D,family = poisson)
summary(mod)

#### negative binomial
summary(MASS::glm.nb(y~x*z,data=D))
mod=flipscores(y~x*z,data=D,family="negbinom")
summary(mod)

```

